import { useEffect } from "react";
import type { UserFeedback } from "../api/existingFeedbackApi";

interface FeedbackDebugInfo {
  userId: string | null;
  testServiceId: string | null;
  bookingStatus: string;
  existingFeedback: UserFeedback | null;
  isCheckingFeedback: boolean;
}

export const useFeedbackDebug = ({
  userId,
  testServiceId,
  bookingStatus,
  existingFeedback,
  isCheckingFeedback
}: FeedbackDebugInfo) => {
  
  useEffect(() => {
    // Chá»‰ debug khi booking completed
    if (bookingStatus === "Completed" && userId && testServiceId) {
      
      // Log thÃ´ng tin cÆ¡ báº£n
      console.group("ðŸ” FEEDBACK DEBUG ANALYSIS");
      console.log("ðŸ“‹ Basic Info:", {
        userId,
        testServiceId,
        bookingStatus,
        timestamp: new Date().toISOString()
      });
      
      // Log tráº¡ng thÃ¡i checking
      console.log("â³ Checking State:", {
        isCheckingFeedback,
        hasUserId: !!userId,
        hasTestServiceId: !!testServiceId
      });
      
      // PhÃ¢n tÃ­ch chi tiáº¿t feedback
      if (existingFeedback) {
        console.log("ðŸ“Š Existing Feedback Analysis:", {
          id: existingFeedback.id,
          userId: existingFeedback.userId,
          testServiceId: existingFeedback.testServiceId,
          rating: existingFeedback.rating,
          ratingType: typeof existingFeedback.rating,
          hasComment: !!existingFeedback.comment,
          commentLength: existingFeedback.comment?.length || 0,
          createdAt: existingFeedback.createdAt,
          updatedAt: existingFeedback.updatedAt
        });
        
        // Kiá»ƒm tra validation
        const isValidFeedback = 
          typeof existingFeedback === 'object' &&
          existingFeedback.id &&
          existingFeedback.userId &&
          existingFeedback.testServiceId &&
          typeof existingFeedback.rating === 'number' &&
          existingFeedback.rating >= 1 && 
          existingFeedback.rating <= 5;
          
        console.log("âœ… Validation Check:", {
          isValidFeedback,
          hasId: !!existingFeedback.id,
          hasUserId: !!existingFeedback.userId,
          hasTestServiceId: !!existingFeedback.testServiceId,
          ratingIsNumber: typeof existingFeedback.rating === 'number',
          ratingInRange: existingFeedback.rating >= 1 && existingFeedback.rating <= 5
        });
        
        // Cáº£nh bÃ¡o náº¿u cÃ³ váº¥n Ä‘á»
        if (!isValidFeedback) {
          console.warn("ðŸš¨ INVALID FEEDBACK DETECTED!");
          console.warn("This feedback should not be displayed as it fails validation");
        }
        
        // Kiá»ƒm tra xem cÃ³ pháº£i lÃ  feedback tá»± Ä‘á»™ng khÃ´ng
        if (existingFeedback.rating === 5 && (!existingFeedback.comment || existingFeedback.comment === "tá»‘t")) {
          console.warn("ðŸ¤– POTENTIAL AUTO-GENERATED FEEDBACK DETECTED!");
          console.warn("Rating: 5 stars with minimal/default comment");
          
          // Kiá»ƒm tra timing
          const createdTime = new Date(existingFeedback.createdAt);
          const updatedTime = new Date(existingFeedback.updatedAt);
          const timeDiff = updatedTime.getTime() - createdTime.getTime();
          
          console.log("â° Timing Analysis:", {
            createdAt: existingFeedback.createdAt,
            updatedAt: existingFeedback.updatedAt,
            timeDifferenceMs: timeDiff,
            timeDifferenceSeconds: timeDiff / 1000,
            possibleAutoGenerated: timeDiff < 1000 // Less than 1 second difference
          });
        }
        
      } else {
        console.log("ðŸ“ No existing feedback found - this is normal for new bookings");
      }
      
      console.groupEnd();
    }
  }, [userId, testServiceId, bookingStatus, existingFeedback, isCheckingFeedback]);
  
  // Return analysis result
  return {
    hasValidFeedback: existingFeedback && 
      typeof existingFeedback === 'object' &&
      existingFeedback.id &&
      existingFeedback.userId &&
      existingFeedback.testServiceId &&
      typeof existingFeedback.rating === 'number' &&
      existingFeedback.rating >= 1 && 
      existingFeedback.rating <= 5,
    
    isPotentialAutoFeedback: existingFeedback?.rating === 5 && 
      (!existingFeedback.comment || existingFeedback.comment === "tá»‘t")
  };
};
